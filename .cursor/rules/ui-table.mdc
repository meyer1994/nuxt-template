---
globs: app/**/Table*.vue
alwaysApply: false
---
# UI Table Component Rules

## Data Structure & Columns

Define table data as typed arrays and columns using the `TableColumn<T>[]`
interface:

```vue
<script setup lang="ts">
import type { AppRouterOutputs } from '@@/server/trpc'
import type { TableColumn } from '@nuxt/ui'

type Item = AppRouterOutputs['node']['list'][number]

const columns: TableColumn<Item>[] = [
  {
    id: 'id' as const,
    accessorKey: 'id',
    header: 'ID',
  },
  {
    id: 'parentId' as const,
    accessorKey: 'parentId',
    header: 'Parent ID',
  },
  {
    id: 'createdAt' as const,
    accessorKey: 'createdAt',
    header: 'Created At',
  },
  {
    id: 'actions' as const,
    header: 'Ações',
  },
]
</script>
```

## Using Template Slots for Cell Rendering

Prefer template slots (`#columnId-cell`) for complex cell content over `h()`
function:

```vue
<script setup lang="ts">
type Keys = keyof Item | 'actions'

// Column visibility state
const visible: Ref<Record<Keys, boolean>> = ref({
  id: true,
  parentId: true,
  createdAt: false,
  actions: true,
})

const table = useTemplateRef('table')
</script>

<template>
  <UTable
    ref="table"
    v-model:column-visibility="visible"
    :columns="columns"
    :data="items"
    @select="e => handleSelect(e.original)"
  >
    <!-- ID Column -->
    <template #id-cell="{ row }">
      <span class="font-bold font-mono text-sm">
        #{{ row.original.id.substring(0, 8) }}
      </span>
    </template>

    <!-- Parent ID Column -->
    <template #parentId-cell="{ row }">
      <span class="font-mono text-sm">
        {{ row.original.parentId || 'N/A' }}
      </span>
    </template>

    <!-- Data Column with truncation -->
    <template #data-cell="{ row }">
      <span
        class="text-sm"
        :title="JSON.stringify(row.original.data)"
      >
        {{ JSON.stringify(row.original.data).length >= 30
          ? JSON.stringify(row.original.data).substring(0, 27) + '...'
          : JSON.stringify(row.original.data) }}
      </span>
    </template>

    <!-- Date Column with NuxtTime -->
    <template #createdAt-cell="{ row }">
      <NuxtTime
        :datetime="row.original.createdAt"
        title
      />
    </template>

    <!-- Actions Column -->
    <template #actions-cell="{ row }">
      <div class="flex items-center gap-1">
        <UButton
          icon="i-lucide-trash-2"
          color="error"
          variant="ghost"
          size="sm"
          title="Excluir node"
          @click="handleDelete(row.original)"
        />
      </div>
    </template>
  </UTable>
</template>
```

## Column Visibility Control

Use `v-model:column-visibility` with a dropdown menu for toggling columns:

```vue
<script setup lang="ts">
type Keys = keyof Item | 'actions'

const columns: TableColumn<Item>[] = [
  { id: 'id' as const, accessorKey: 'id', header: 'ID' },
  { id: 'email' as const, accessorKey: 'email', header: 'Email' },
  { id: 'actions' as const, header: 'Actions' },
]

// Map column IDs to labels for dropdown
const MAP_ID_TO_LABEL: Record<string, string> = columns
  .reduce((a, c) => ({ ...a, [c.id as string]: c.header }), {})

const visible: Ref<Record<Keys, boolean>> = ref({
  id: true,
  email: true,
  actions: true,
})

const table = useTemplateRef('table')
</script>

<template>
  <div class="flex flex-col flex-1 w-full">
    <!-- Filter and column controls -->
    <div class="flex items-center gap-2 px-4 py-3.5 border-b border-accented">
      <slot name="top" />

      <UButton
        icon="i-lucide-refresh-cw"
        color="neutral"
        variant="ghost"
        size="sm"
        title="Atualizar"
        class="ml-auto"
        @click="handleRefresh"
      />

      <UDropdownMenu
        :items="
          table
            ?.tableApi
            ?.getAllColumns()
            .filter((column) => column.getCanHide())
            .map((column) => ({
              label: (MAP_ID_TO_LABEL[column.id as Keys] ?? column.id),
              type: 'checkbox' as const,
              checked: column.getIsVisible(),
              onUpdateChecked: (checked: boolean) =>
                table
                  ?.tableApi
                  ?.getColumn(column.id)
                  ?.toggleVisibility(!!checked),
              // prevents the select menu from closing
              onSelect: (e: Event) => e.preventDefault(),
            }))
        "
        :content="{ align: 'end' }"
      >
        <UButton
          label="Colunas"
          color="neutral"
          variant="outline"
          trailing-icon="i-lucide-chevron-down"
          aria-label="Selecionar colunas"
        />
      </UDropdownMenu>
    </div>

    <UTable
      ref="table"
      v-model:column-visibility="visible"
      :columns="columns"
      :data="items"
      class="flex-1"
    />
  </div>
</template>
```

## Component Rendering in Cells (h function)

Use Vue's `h` function and `resolveComponent` for rendering components in column
definitions when not using slots:

```vue
<script setup lang="ts">
import { h, resolveComponent } from 'vue'

const UBadge = resolveComponent('UBadge')
const UButton = resolveComponent('UButton')

const columns: TableColumn<Payment>[] = [{
  accessorKey: 'status',
  header: 'Status',
  cell: ({ row }) => {
    const color = ({
      paid: 'success' as const,
      failed: 'error' as const,
      refunded: 'neutral' as const
    })[row.getValue('status') as string]

    return h(UBadge, { class: 'capitalize', variant: 'subtle', color }, () => row.getValue('status'))
  }
}, {
  id: 'actions',
  cell: ({ row }) => {
    return h('div', { class: 'flex items-center gap-1' }, 
      h(UButton, {
        icon: 'i-lucide-trash-2',
        color: 'error',
        variant: 'ghost',
        size: 'sm',
        onClick: () => handleDelete(row.original)
      })
    )
  }
}]
</script>
```

## Table Configuration

Common table props and configuration patterns:

```vue
<template>
  <UTable
    ref="table"
    :loading="loading"
    loading-animation="carousel"
    :filter="filter"
    :global-filter="filter"
    :columns="columns"
    :data="items"
    :sticky="true"
    :empty-state="{
      icon: 'i-lucide-box',
      label: 'Nenhum item encontrado',
    }"
    :ui="{
      tr: 'hover:bg-muted cursor-pointer',
    }"
    class="flex-1"
    @select="e => handleSelect(e.original)"
  />
</template>
```

## Common Patterns

### Row Selection

```vue
<script setup lang="ts">
const rowSelection = ref({})

const columns: TableColumn<Payment>[] = [{
  id: 'select',
  header: ({ table }) => h(UCheckbox, {
    'modelValue': table.getIsSomePageRowsSelected() ? 'indeterminate' : table.getIsAllPageRowsSelected(),
    'onUpdate:modelValue': (value: boolean | 'indeterminate') => table.toggleAllPageRowsSelected(!!value)
  }),
  cell: ({ row }) => h(UCheckbox, {
    'modelValue': row.getIsSelected(),
    'onUpdate:modelValue': (value: boolean | 'indeterminate') => row.toggleSelected(!!value)
  })
}]
</script>

<template>
  <UTable v-model:row-selection="rowSelection" :data="data" :columns="columns" />
</template>
```

### Column Sorting

```vue
<script setup lang="ts">
import { h } from 'vue'

const sorting = ref([{ id: 'email', desc: false }])

const columns: TableColumn<Payment>[] = [{
  accessorKey: 'email',
  header: ({ column }) => {
    const isSorted = column.getIsSorted()
    return h(UButton, {
      color: 'neutral',
      variant: 'ghost',
      label: 'Email',
      icon: isSorted ? (isSorted === 'asc' ? 'i-lucide-arrow-up-narrow-wide' : 'i-lucide-arrow-down-wide-narrow') : 'i-lucide-arrow-up-down',
      onClick: () => column.toggleSorting(column.getIsSorted() === 'asc')
    })
  }
}]
</script>

<template>
  <UTable v-model:sorting="sorting" :data="data" :columns="columns" />
</template>
```

### Expandable Rows

```vue
<script setup lang="ts">
const expanded = ref({})
</script>

<template>
  <UTable v-model:expanded="expanded" :data="data" :columns="columns">
    <template #expanded="{ row }">
      <pre>{{ row.original }}</pre>
    </template>
  </UTable>
</template>
```

### Component with Events

```vue
<script setup lang="ts">
type Props = {
  items: Item[]
  filter?: string
  loading?: boolean
}

const props = defineProps<Props>()
const emit = defineEmits<{
  'update-item': [item: Item]
  'delete-item': [item: Item]
  'select-item': [item: Item]
  'refresh-table': []
}>()

</script>

<template>
  <UTable
    :data="props.items"
    :columns="columns"
    @select="e => emit('select-item', e.original)"
  >
    <template #actions-cell="{ row }">
      <UButton
        icon="i-lucide-trash-2"
        color="error"
        variant="ghost"
        size="sm"
        @click="emit('delete-item', row.original)"
      />
    </template>
  </UTable>
</template>
```

## Complete Example

```vue
<script setup lang="ts">
import type { AppRouterOutputs } from '@@/server/trpc'
import type { TableColumn } from '@nuxt/ui'

type Item = AppRouterOutputs['node']['list'][number]

type Props = {
  items: Item[]
  filter?: string
  loading?: boolean
}

const props = defineProps<Props>()
const emit = defineEmits<{
  'select-item': [item: Item]
  'delete-item': [item: Item]
  'refresh-table': []
}>()

type Keys = keyof Item | 'actions'

const columns: TableColumn<Item>[] = [
  { id: 'id' as const, accessorKey: 'id', header: 'ID' },
  { id: 'parentId' as const, accessorKey: 'parentId', header: 'Parent ID' },
  { id: 'createdAt' as const, accessorKey: 'createdAt', header: 'Created At' },
  { id: 'actions' as const, header: 'Actions' },
]

const MAP_ID_TO_LABEL: Record<string, string> = columns
  .reduce((a, c) => ({ ...a, [c.id as string]: c.header }), {})

const visible: Ref<Record<Keys, boolean>> = ref({
  id: true,
  parentId: true,
  createdAt: false,
  actions: true,
})

const table = useTemplateRef('table')
</script>

<template>
  <div class="flex flex-col flex-1 w-full">
    <div class="flex items-center gap-2 px-4 py-3.5 border-b border-accented">
      <slot name="top" />

      <UButton
        icon="i-lucide-refresh-cw"
        color="neutral"
        variant="ghost"
        size="sm"
        class="ml-auto"
        @click="emit('refresh-table')"
      />

      <UDropdownMenu
        :items="
          table
            ?.tableApi
            ?.getAllColumns()
            .filter((column) => column.getCanHide())
            .map((column) => ({
              label: (MAP_ID_TO_LABEL[column.id as Keys] ?? column.id),
              type: 'checkbox' as const,
              checked: column.getIsVisible(),
              onUpdateChecked: (checked: boolean) =>
                table
                  ?.tableApi
                  ?.getColumn(column.id)
                  ?.toggleVisibility(!!checked),
              onSelect: (e: Event) => e.preventDefault(),
            }))
        "
        :content="{ align: 'end' }"
      >
        <UButton
          label="Colunas"
          color="neutral"
          variant="outline"
          trailing-icon="i-lucide-chevron-down"
        />
      </UDropdownMenu>
    </div>

    <UTable
      ref="table"
      v-model:column-visibility="visible"
      :loading="props.loading"
      loading-animation="carousel"
      :filter="props.filter"
      :global-filter="filter"
      :columns="columns"
      :data="props.items"
      :sticky="true"
      :empty-state="{
        icon: 'i-lucide-box',
        label: 'Nenhum item encontrado',
      }"
      :ui="{
        tr: 'hover:bg-muted cursor-pointer',
      }"
      class="flex-1"
      @select="e => emit('select-item', e.original)"
    >
      <template #id-cell="{ row }">
        <span class="font-bold font-mono text-sm">
          #{{ row.original.id.substring(0, 8) }}
        </span>
      </template>

      <template #parentId-cell="{ row }">
        <span class="font-mono text-sm">
          {{ row.original.parentId || 'N/A' }}
        </span>
      </template>

      <template #createdAt-cell="{ row }">
        <NuxtTime
          :datetime="row.original.createdAt"
          title
        />
      </template>

      <template #actions-cell="{ row }">
        <div class="flex items-center gap-1">
          <UButton
            icon="i-lucide-trash-2"
            color="error"
            variant="ghost"
            size="sm"
            @click="emit('delete-item', row.original)"
          />
        </div>
      </template>
    </UTable>
  </div>
</template>
```

## Key Guidelines

- Always type your data with TypeScript interfaces
- **Prefer template slots (`#columnId-cell`) for complex cell content** over
  `h()` function
- Use `h()` function only when needed for dynamic column definitions
- Use `useTemplateRef('table')` to access table API for column visibility and
  other operations
- Use `v-model:column-visibility` with typed ref for column visibility control
- Create `MAP_ID_TO_LABEL` for dropdown menu labels
- Use `id: 'columnId' as const` pattern for column IDs
- Use `<NuxtTime>` component for date formatting
- Common props: `sticky`, `loading`, `loading-animation`, `filter`,
  `global-filter`, `class="flex-1"`
- Use `:empty-state` prop for custom empty state messages
- Use `:ui` prop for custom table styling (e.g., hover effects)
- Use `@select` event for row click handling
- Emit events from component for parent handling (`update-item`, `delete-item`,
  `select-item`, `refresh-table`)